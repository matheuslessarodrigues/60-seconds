pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- a game for fc jam 2018

---------------- constants

-- map
initial_map=1
map_count=1
next_map_time=20

-- camera shake
shake_force=7
shake_time=4

-- physics
gravity=0.3

f_solid=0x1
f_deadly=0x2
f_goal=0x4

c_mask=0x0
c_mask=bor(c_mask,f_solid)
c_mask=bor(c_mask,f_deadly)
c_mask=bor(c_mask,f_goal)

map_colliders={}
map_colliders.__index=function() return {0,0,8,8} end
setmetatable(map_colliders,map_colliders)

-- player
min_vel_y=-3.3

player_vel=1.5
player_jump=-4
player_jump_time=4

player_death_anim_time=20
player_anim_spd=4
player_anim={1}

---------------- default functions

function _init()
	player={}
	maps={}
	cur_map={}

	shake_timer=0

	level=0

	reset_player(player)
end

function _draw()
	cls()
	draw_map(1)

	draw_player(player)
end

function _update()
	update_player(player)
end

---------------- init

function reset_player(p,l)
	return p
end

---------------- draws

function draw_player(p)
end

---------------- updates

function update_player(p)
end

---------------- physics

function reset_rigidbody(rb)
	rb.x=0
	rb.y=0
	rb.w=8
	rb.h=8

	rb.vx=0
	rb.vy=0

	rb.grounded=false

	return rb
end

function update_rigidbody(rb)
	rb.x+=rb.vx

	rb.vy+=g
	rb.vy=max(rb.vy,min_vel_y)

	rb.y+=rb.vy
end

function draw_rigidbody(rb,c)
	local x0=round(rb.x)
	local y0=round(rb.y)
	local x1=round(x0+rb.w-1)
	local y1=round(y0+rb.h-1)
	rect(x0,y0,x1,y1,c)
end

function collide(a,b)
	if a==b then
		return false,0,0
	end

	return false,0,0
end

function map_collide(c)
	local function try_col(c,mx,my)
		local i,j=map_offset(level,mx,my)

		local m=mget(i,j)
		local f=fget(m)
		local solid=band(f,c_mask)!=0x0

		if mx<0 or mx>15 then
			solid=true
			f=f_solid
			m=-1
		elseif my<0 or my>15 then
			solid=false
		end

		if not solid then
			return 0x0,0,0
		end

		local mc=map_colliders[m]
		local t={}
		t.x=mx*8+mc[1]
		t.y=my*8+mc[2]
		t.w=mc[3]
		t.h=mc[4]

		if band(f,f_solid)==0 then
			local r,rx,ry=collide(c,t)
			if r then
				return f,rx,ry
			end
		end

		return 0x0,0,0
	end

	local mx=flr(c.x/8)
	local my=flr(c.y/8)

	local rx=0
	local ry=0
	local f=0x0

	local function col(mx,my)
		local rf,x,y=try_col(c,mx,my)
		f=bor(f,rf)
		rx+=x
		ry+=y
	end

	col(mx,my)
	col(c,mx+1,my)
	col(c,mx,my+1)
	col(c,mx+1,my+1)

	return f,rx,ry
end

---------------- map

function load_map(l)
	fade(0)

	if l>map_count then
		level=0
		return
	end

	level=l
	cur_map=scan_map(l)

	reset_player(player,l)
end

function scan_map(l)
	local m=maps[l]
	if m then
		return m
	end

	m={
		player={x=0,y=0},
	}

	local oi,oj=map_offset(l,0,0)

	for i=0,16 do
		for j=0,16 do
			local x=oi+i
			local y=oj+j
			local mi=mget(x,y)

			if mi==1 then -- player
				mset(x,y,0)
				m.player={x=i*8,y=j*8}
			end
		end
	end

	maps[l]=m
	return m
end

function map_offset(l,i,j)
	return i+l*16,j
end

function draw_map(l)
	local i,j=map_offset(l,0,0)
	map(i,j,0,0,16,16)
end

---------------- camera

function begin_shake()
	shake_timer=shake_time
end

function update_shake()
	if shake_timer==1 then
		camera()
	end

	shake_timer-=1
	if shake_timer>0 then
		local f=shake_force
		local x=rnd(f)-f/2
		local y=rnd(f)-f/2
		camera(flr(x),flr(y))
	end
end

---------------- helpers

function round(x)
	return flr(x+0.5)
end

function fade(fa)
	fa=max(min(1,fa),0)

	local fn=8
	local pn=15
	local fc=1/fn
	local fi=flr(fa/fc)+1

	for n=1,pn do
		pal(n,fades[n][fi],0)
	end
end

fade_time=10
fades={
	{1,1,1,1,0,0,0,0},
	{2,2,2,1,1,0,0,0},
	{3,3,4,5,2,1,1,0},
	{4,4,2,2,1,1,1,0},
	{5,5,2,2,1,1,1,0},
	{6,6,13,5,2,1,1,0},
	{7,7,6,13,5,2,1,0},
	{8,8,9,4,5,2,1,0},
	{9,9,4,5,2,1,1,0},
	{10,15,9,4,5,2,1,0},
	{11,11,3,4,5,2,1,0},
	{12,12,13,5,5,2,1,0},
	{13,13,5,5,2,1,1,0},
	{14,9,9,4,5,2,1,0},
	{15,14,9,4,5,2,1,0}
}

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000ff00ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000f1ff1f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000f00f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddd55551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d5666611000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666661000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666661000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666661000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666661000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
51666611000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000004040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000004040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040400000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
